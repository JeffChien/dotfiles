# Keybindings:
# | Key                      | Context / Mode        | Description                                           |
# |--------------------------|-----------------------|-------------------------------------------------------|
# | M-s (prefix)             | global                | Set tmux prefix to Meta-s                             |
# | M-Up (no prefix)         | global                | Enter copy mode                                       |
# | n (copy-mode-vi)         | copy-mode-vi          | Move to next prompt on same line                      |
# | p (copy-mode-vi)         | copy-mode-vi          | Move to previous prompt (line after prompt)           |
# | P (copy-mode-vi)         | copy-mode-vi          | Select previous command output                        |
# | N (copy-mode-vi)         | copy-mode-vi          | Select next command output                            |
# | WheelUpPane (copy-mode-vi)| copy-mode-vi         | Scroll up 2 lines per wheel tick                      |
# | WheelDownPane (copy-mode-vi)| copy-mode-vi       | Scroll down 2 lines per wheel tick                    |
# | v (copy-mode-vi)         | copy-mode-vi          | Begin selection                                       |
# | prefix + d               | global (prefix)       | Detach client                                         |
# | prefix + =               | global (prefix)       | Choose/paste buffer (choose-buffer with preview)      |
# | prefix + m               | global (prefix)       | Toggle maximize pane (resize-pane -Z)                 |
# | prefix + ;               | global (prefix)       | Open shell popup (-E)                                 |
# | prefix + x               | global (prefix)       | Open pane kill-confirm popup script                   |
# | prefix + r               | global (prefix)       | Reload tmux config (source-file)                      |
# | prefix + Ctrl-s          | (tmux-resurrect)      | Save session (provided by tmux-resurrect)             |
# | prefix + Ctrl-r          | (tmux-resurrect)      | Restore session (provided by tmux-resurrect)          |

# TMUX_PLUGIN_MANAGER_PATH is needed
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-resurrect'
## doc
# prefix + Ctrl-s - save
# prefix + Ctrl-r - restore

set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'jimeh/tmux-themepack'
set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @plugin 'roosta/tmux-fuzzback'

set -g @tmux-which-key-disable-autobuild 0
set -g @tmux-which-key-xdg-enable 1
set -g @plugin 'alexwforsythe/tmux-which-key'

# don't spawn login shell, becaulse it has been set by terminal emulator.
# clear the default command, because if default command and default shell
# are all set to $SHELL, it like nesting shell, that cause rc to be sourced
# twice.
set -g default-command ""
set -g default-shell "$SHELL"
set -g set-clipboard on
set -g mouse on # allowing mouse to select to clipboard and resize pane

# Make switching to cmd mode in zsh quick!
set -g repeat-time 250

## update the TERM variable of terminal emulator when creating a new session or attaching a existing session
set -g update-environment 'DISPLAY \
      SSH_ASKPASS \
      SSH_AGENT_PID \
      SSH_CONNECTION \
      WINDOWID \
      XAUTHORITY \
      TERM'

# status bar positon top
set -g status-position top

# Start pane numbering at 1
set -g base-index 1

# Sane scrolling
# set -g terminal-overrides 'xterm*:smcup@:rmcup@'
set -g terminal-overrides '\*:smcup@:rmcup@'

set -g word-separators ' @(){}'

setw -g xterm-keys on

# vi-style controls in copy mode
set -g mode-keys vi

set -g word-separators ' @(){}'

set -g @plugin 'dracula/tmux'

# powerline symbols, triangle symbol [true / false*]
set -g @dracula-show-powerline false

# window flags [true / false]
# see window-status-format for detail
set -g @dracula-show-flags true

# it can accept `session`, `smiley`*, `window`, or any character.
set -g @dracula-show-left-icon session

# high contrast border, [true / false*]
set -g @dracula-border-contrast false

# available plugins: battery, cpu-usage, git, gpu-usage, ram-usage, network, network-bandwidth, network-ping, weather, time
set -g @dracula-plugins "cpu-usage ram-usage"

# false* for CPU percentange, true for system load
set -g @dracula-cpu-display-load true

set -g @dracula-refresh-rate 15

# Set the prefix key
set -g prefix M-s

# trigger copy mode by
bind -n M-Up copy-mode

## Jump between prompts, this needs special escape sequences on prompt, check manpage google how to configure for 
## different prompt repository.

bind -T copy-mode-vi n send-keys -X next-prompt # on the same line of prompt
bind -T copy-mode-vi p send-keys -X previous-prompt -o # line after the prompt

# select the previous command output
bind -T copy-mode-vi P \; \
      send-keys -X clear-selection \; \
      send-keys -X previous-prompt -o \; \
      send-keys -X next-prompt \; \
      send-keys -X cursor-left -n 2 \; \
      send-keys -X begin-selection \; \
      send-keys -X previous-prompt -o

# select the next command output
bind -T copy-mode-vi N \; \
      send-keys -X clear-selection \; \
      send-keys -X next-prompt \; \
      send-keys -X cursor-down \; \
      send-keys -X begin-selection \; \
      send-keys -X next-prompt \; \
      send-keys -X cursor-left -n 2

# Ctrl-D: Detach
bind d detach-client

# Ctrl-=: choose and past buffer
bind = choose-buffer -F '#{buffer_sample}'

# toggle maximize pane
bind m resize-pane -Z

bind \; popup -E 

bind x popup -E "$XDG_CONFIG_HOME/tmux/libs/kill-confirm.sh pane"

bind r source-file ~/.config/tmux/tmux.conf

# When scrolling with mouse wheel, reduce number of scrolled rows per tick to "2" (default is 5)
bind -T copy-mode-vi WheelUpPane       select-pane \; send-keys -X -N 2 scroll-up
bind -T copy-mode-vi WheelDownPane     select-pane \; send-keys -X -N 2 scroll-down
bind -T copy-mode-vi v send -X begin-selection

set -g default-terminal "screen-256color"
# tell Tmux that outside terminal supports true color
set -ga terminal-overrides ",xterm-256color*:Tc"

run-shell "$TMUX_PLUGIN_MANAGER_PATH/tpm/tpm"
